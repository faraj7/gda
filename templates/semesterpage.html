$def with (SemesterInst, Render)

$ S = sessionmaker(bind=DB)()

$ ThisOfferings = S.query(Offering).filter(Offering.semester == SemesterInst).join(Offering.subject).order_by(Subject.code)

$ Questions = S.query(QuestionsOffering)

$ quest1 = []
$ quest2 = []
$ quest3 = []
$ quest4 = []
$ quest5 = []
$ quest6 = []
$for Line in ThisOfferings:
  $ SearchRate = S.query(OfferingRate).filter(OfferingRate.offering_id == Line.id)
  $for Rate in SearchRate:
    $ quest1.append(Rate.question1)
    $ quest2.append(Rate.question2)
    $ quest3.append(Rate.question3)
    $ quest4.append(Rate.question4)
    $ quest5.append(Rate.question5)
    $ quest6.append(Rate.question6)


<!DOCTYPE html>
<html>
  <head>
    $:Render.includes()
    <title>$BaseTitle - $(SemesterInst.sem)s$SemesterInst.year</title>
  </head>
  <body>
    <!-- Fixed navbar -->
    $:Render.navbar(Render.user_id)
    <!-- Begin page content -->
    <div class="container" id="oferecimentos">
        <div class="scrollable-area col-sm-6">
          <input type="text" class="search" placeholder="Busca por disciplina ou docente"/>
          <table class="table table-striped table-condensed sortable table-hover">
                <thead>
                  <tr>
                    <th class="col-sm-3"> Código</th>
                    <th class="col-sm-4">Docente</th>
                    <th> A </th>
                    <th> B </th>
                    <th> C </th>
                    <th> D </th>
                    <th> E </th>
                    <th> F </th>
                  </tr>
                </thead>
                <tbody class="list">
                $for Line in ThisOfferings:
                  $ URL = Line.EncodeURL()
                  $ Code = '%s %s' % (Line.subject.code, Line.code)
                  $ Sem = '%ss%s' % (Line.semester.sem, Line.semester.year)
                  $ SearchRate = S.query(OfferingRate).filter(OfferingRate.offering_id == Line.id)
                  $ Rated = 0
                  $for Lin in SearchRate:
                    $ Rate = Lin
                    $ Rated = 1
                  <tr class="clickable-row" data-url="$URL" data-toggle="tooltip" title="$Line.subject.name">
                    <td><a class = "codigo black-link" href="$URL">$Code</a></td>
                    <td><a class = "docente black-link" href="$Line.teacher.EncodeURL()">$Line.teacher.name</a></td>
                    $if Rated:
                      <td id="q1">$Rate.question1</td>
                      <td id="q2">$Rate.question2</td>
                      <td id="q3">$Rate.question3</td>
                      <td id="q4">$Rate.question4</td>
                      <td id="q5">$Rate.question5</td>
                      <td id="q6">$Rate.question6</td>
                    $else:
                      $for i in range(0,6):
                        <td> <i class="fa fa-minus"></i> </td>
                  </tr>
                </tbody>
              </table>
        <script>
          var options = {
            valueNames: ['codigo', 'docente']
          };
          var userList = new List('oferecimentos', options);
        </script>
      </div>
      <div class="col-sm-6">
        <div data-spy="affix">
          <div id="graph"></div>
        </div>
      </div>
          <script>

          (function() {

            var d3 = Plotly.d3;

            var WIDTH_IN_PERCENT_OF_PARENT = 100,
              HEIGHT_IN_PERCENT_OF_PARENT = 90;

            var gd3 = d3.select('#graph')
              .append('div')
              .style({
                  width: WIDTH_IN_PERCENT_OF_PARENT + '%',
                  'margin-left': (100 - WIDTH_IN_PERCENT_OF_PARENT) / 2 + '%',

                  height: HEIGHT_IN_PERCENT_OF_PARENT + 'vh'
                  //'margin-top': (100 - HEIGHT_IN_PERCENT_OF_PARENT) / 2 + 'vh'
              });

            var gd = gd3.node();

            var xData = ['<br><b>(A)</b> Planejamento<br>da Bibliografia',
            '<br><b>(B)</b> Didática e<br> Técnica de Ensino',
            '<br><b>(C)</b> Interesse<br>pelo Aluno',
            '<br><b>(D)</b> Relacionamento<br>com alunos',
            '<br><b>(E)</b> Adequação<br>da Avaliação',
            '<br><b>(F)</b> Contribuição<br>para aprendizado<br>'];
            var yData1 = [
              $quest1 ,
              $quest2 ,
              $quest3 ,
              $quest4 ,
              $quest5 ,
              $quest6 ,
            ];
            var data1 = [];
            for ( var i = 0; i < xData.length; i ++ ) {
              var result = {
                type: 'box',
                showlegend: true,
                y: yData1[i],
                name: xData[i],
                boxpoints: 'all',
                jitter: 0.3,
                whiskerwidth: 0.2,
                fillcolor: 'cls',
                marker: {
                  size: 4
                },
                line: {
                  width: 1
                }
              };
              data1.push(result);
            };

            var layout1 = {
                title: '$SemesterInst.semº semestre de $SemesterInst.year',
                yaxis: {
                    autorange: true,
                    showgrid: true,
                    zeroline: false,
                    dtick: 5,
                    gridcolor: 'rgb(255, 255, 255)',
                    gridwidth: 1
                },
                xaxis: {
                  color: 'white'
                },
                margin: {
                    l: 40,
                    r: 30,
                    b: 80,
                    t: 100
                },
                legend: {
                    x: 1,
                    y: 1.05,
                    //yanchor: 'middle',
                    traceorder: 'normal',
                    //tracegroupgap: 100,
                    font: {
                      family: 'sans-serif',
                      size: 14,
                      color: '#000'
                    },
                  }
              //  paper_bgcolor: 'rgb(243, 243, 243)',
              //  plot_bgcolor: 'rgb(243, 243, 243)',
              //  width: 700,
              //  height: 500,
              //  showlegend: true
            };

            Plotly.plot(gd, data1, layout1, {displaylogo: false});

            var rating = [1,2,3,4,5,6];
            jQuery( ".clickable-row" )
              .mouseover(function() {
                rating[0] = jQuery( this ).find( "#q1" ).text();
                rating[1] = jQuery( this ).find( "#q2" ).text();
                rating[2] = jQuery( this ).find( "#q3" ).text();
                rating[3] = jQuery( this ).find( "#q4" ).text();
                rating[4] = jQuery( this ).find( "#q5" ).text();
                rating[5] = jQuery( this ).find( "#q6" ).text();
                var teacher_name = jQuery( this ).find( ".docente" ).text();
                var trace1 = {
                  name: teacher_name,
                  x: xData,
                  y: rating ,
                  mode: 'markers',
                  showlegend: true,
                  marker: { size: 10, color: 'black', symbol: 'diamond'},
                  type: 'scatter'
                };
                Plotly.addTraces(gd, trace1);
              })
              .mouseout(function() {
                Plotly.deleteTraces(gd,[-1]);

              });


              window.onresize = function() {
                Plotly.Plots.resize(gd);
              };
              })();

                </script>

    </div>
    $:Render.footer()
  </body>
</html>
