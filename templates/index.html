$def with (Render)

$ S = sessionmaker(bind=DB)()

$ MyUser = S.query(User).filter(User.id == Render.user_id).one()

$ Ratings = S.query(StudentRate).filter(StudentRate.user_id == MyUser.id).join(StudentRate.offering).join(Offering.semester).order_by(desc((Semester.year)*2 + Semester.sem))

$ Ratings = S.query(Enrollment).filter(Enrollment.student_id == MyUser.id).join(Enrollment.offering).join(Offering.semester).order_by(desc((Semester.year)*2 + Semester.sem))

$ Enrolls = S.query(Enrollment).filter(Enrollment.student_id == MyUser.id)

<!DOCTYPE html>
<html>
<head>
  $:Render.includes()
  <title>$BaseTitle</title>
</head>
<body>
  <!-- Fixed navbar -->
  $:Render.navbar(Render.user_id)
  <!-- Begin page content -->
  <div class="container">
      <div class="col-sm-4">
        <br>
        <a href="http://www.cabs.fee.unicamp.br/?t=52_GDA" target="_blank">
          <img class="img-responsive" src="/static/images/old/GDA$random.randrange(1,16)_capa.jpg" alt="gda">
        </a>
      </div>
  <div class="col-sm-4" id="oferecimentos">
    <br>
    <div class="panel-group" id="accordion">
    $ i=0
    $for thissemester in S.query(Semester).order_by(desc((Semester.year)*2 + Semester.sem)):
      $ EnrollSemester = S.query(Enrollment).filter(Enrollment.student_id == MyUser.id).join(Enrollment.offering).filter(Offering.semester_id == thissemester.id)
      $if EnrollSemester.count():
        $ i = i + 1
        $ semesterRated = 0
        $for enroll in EnrollSemester:
          $ semesterRated = semesterRated + S.query(StudentRate).filter(StudentRate.user_id == MyUser.id).filter(StudentRate.offering_id == enroll.offering_id).count()
        $if semesterRated == EnrollSemester.count():
          $ lab = "label-default"
        $else:
          $ lab = "label-primary"
        <div class="panel panel-default">
           <div class="panel-heading">
             <h4 class="panel-title">
               <a  class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#collapse$(i)">
               $(thissemester.year).$(thissemester.sem)
               <span class="label $(lab) pull-right">
                 <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                 $(semesterRated) de $(EnrollSemester.count())</span>
              </a>
             </h4>
           </div>
           $if(i==1):
            $ panel_show_hide = "panel-collapse collapse in"
          $else:
            $ panel_show_hide = "panel-collapse collapse"
           <div id="collapse$(i)" class="$(panel_show_hide)">
               <table class="table table-condensed table-hover">
                 <tbody class="list">
                  $for enroll in EnrollSemester:
                     $ URL = enroll.offering.EncodeURL()
                     <tr>
                       <td><a class = "black-link" href="$URL">$(enroll.offering.subject.code)$enroll.offering.code</a></td>
                       <td><a class = "black-link" href="$enroll.offering.teacher.EncodeURL()">$enroll.offering.teacher.name</a></td>
                       $if S.query(StudentRate).filter(StudentRate.user_id == MyUser.id).filter(StudentRate.offering_id == enroll.offering_id).count():
                          <td> <a href="$URL" class="btn btn-default btn-sm"><i class="fa fa-check-square-o" aria-hidden="true"></i></a></td>
                       $else:
                          <td> <a href="$enroll.offering.EvaluationURL()" class="btn btn-primary btn-sm"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></a></td>
                     </tr>
                 </tbody>
               </table>
           </div>
         </div>
  </div>
</div>
$:Render.footer()
</body>
</html>
